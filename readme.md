# Gestor de Tareas con Arquitectura Multi-Base de Datos

Este proyecto es una aplicación web de gestión de tareas desarrollada con Python y Flask. Su propósito principal es servir como una herramienta educativa para demostrar una arquitectura de software moderna que integra múltiples tecnologías de bases de datos, cada una especializada en una tarea específica.

La aplicación permite a los usuarios registrarse, gestionar sus tareas, categorizarlas, registrar el tiempo invertido en ellas y analizar su productividad a través de un dashboard y reportes exportables.

## Características

- **Autenticación de Usuarios**: Registro e inicio de sesión seguros gestionados por Supabase.
- **Gestión Completa de Tareas**: Funcionalidades CRUD (Crear, Leer, Actualizar, Borrar) para las tareas.
- **Categorización**: Gestión de categorías de tareas en una base de datos SQLite local.
- **Registro de Tiempo**: Historial de tiempo invertido por tarea, almacenado en MySQL.
- **Dashboard Analítico**: Visualización del tiempo total agregado por tarea.
- **Exportación de Datos Avanzada**: Descarga de reportes en formato CSV (maestro, personal y por tabla individual).
- **API Segura**: Endpoint con autenticación básica para ser consumido por herramientas de BI como Power BI.
- **Contenerización**: Toda la aplicación y sus servicios están contenerizados con Docker para una fácil instalación y despliegue.

## Arquitectura Técnica

La aplicación utiliza un backend en **Python (Flask)** orquestado a través de **Docker Compose**. La característica más destacada es su capa de datos distribuida:

- **Supabase (PostgreSQL)**: Actúa como la base de datos principal en la nube para los datos transaccionales (tareas) y la autenticación de usuarios.
- **SQLite**: Se utiliza como una base de datos de configuración local, basada en archivos, para almacenar datos de catálogos (categorías).
- **MySQL/MariaDB**: Funciona como una base de datos analítica y de historial, ideal para almacenar logs (registros de tiempo) y realizar agregaciones.

---

## Guía de Instalación y Puesta en Marcha

Sigue estos pasos para tener la aplicación funcionando en tu máquina local.

### Prerrequisitos

- **Docker Desktop**: Asegúrate de tener Docker y Docker Compose instalados y en ejecución. Puedes descargarlo desde [docker.com](https://www.docker.com/products/docker-desktop/).
- **Cuenta de Supabase**: Necesitarás una cuenta gratuita de Supabase.

### Paso 1: Clonar el Repositorio

```bash
git clone <URL_DEL_REPOSITORIO>
cd <NOMBRE_DE_LA_CARPETA>
```

### Paso 2: Configuración del Proyecto en Supabase

1.  **Crea un nuevo proyecto** en tu panel de control de Supabase.
2.  **Crea la tabla `tasks`**:
    - Ve al **SQL Editor** en el menú de la izquierda.
    - Haz clic en **"New query"**.
    - Pega y ejecuta el siguiente código SQL para crear la tabla `tasks` con las columnas necesarias:
    ```sql
    CREATE TABLE public.tasks (
      id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
      created_at timestamp with time zone NOT NULL DEFAULT now(),
      title text NOT NULL,
      done boolean NOT NULL DEFAULT false,
      user_id uuid NOT NULL,
      category_id integer,
      CONSTRAINT tasks_pkey PRIMARY KEY (id),
      CONSTRAINT tasks_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users (id) ON DELETE CASCADE
    );
    ```
3.  **Configura la Seguridad (RLS)**:
    - En el mismo **SQL Editor**, ejecuta el siguiente bloque de código para crear las políticas de seguridad. Esto es **crucial** para que la aplicación funcione.
    ```sql
    -- 1. Habilitar la Seguridad a Nivel de Fila (RLS)
    ALTER TABLE public.tasks ENABLE ROW LEVEL SECURITY;

    -- 2. Política para que los usuarios puedan LEER (SELECT) sus propias tareas
    CREATE POLICY "Los usuarios pueden ver sus propias tareas"
    ON public.tasks FOR SELECT
    TO authenticated
    USING (auth.uid() = user_id);

    -- 3. Política para que los usuarios puedan CREAR (INSERT) tareas para sí mismos
    CREATE POLICY "Los usuarios pueden crear sus propias tareas"
    ON public.tasks FOR INSERT
    TO authenticated
    WITH CHECK (auth.uid() = user_id);

    -- 4. Política para que los usuarios puedan ACTUALIZAR (UPDATE) sus propias tareas
    CREATE POLICY "Los usuarios pueden actualizar sus propias tareas"
    ON public.tasks FOR UPDATE
    TO authenticated
    USING (auth.uid() = user_id);

    -- 5. Política para que los usuarios puedan BORRAR (DELETE) sus propias tareas
    CREATE POLICY "Los usuarios pueden eliminar sus propias tareas"
    ON public.tasks FOR DELETE
    TO authenticated
    USING (auth.uid() = user_id);
    ```

### Paso 3: Configurar las Variables de Entorno

1.  En la raíz del proyecto, encontrarás un archivo llamado `.env.example`. **Crea una copia** de este archivo y renómbrala a `.env`.
2.  **Edita el archivo `.env`** y rellena los valores:
    - `SUPABASE_URL` y `SUPABASE_KEY`: Encuentra estos valores en tu proyecto de Supabase, en la sección **Project Settings > API**.
    - `MYSQL_...`: Puedes dejar los valores por defecto o personalizarlos. La contraseña que pongas aquí será la que usará el contenedor de Docker.
    - `API_...`: Define un usuario y contraseña para el acceso a la API.

### Paso 4: Ejecutar la Aplicación

1.  Abre una terminal en la raíz del proyecto.
2.  Ejecuta el siguiente comando. La primera vez, Docker descargará las imágenes necesarias, lo que puede tardar unos minutos.
    ```bash
    docker-compose up --build -d
    ```
3.  Una vez que los contenedores estén en funcionamiento, la aplicación estará accesible en tu navegador en la siguiente dirección:
    http://localhost:5001

    *(Nota: El puerto por defecto es `5001`. Si está ocupado, puedes cambiarlo en el archivo `docker-compose.yml`)*.

---

## Endpoints de la Aplicación

A continuación se detallan los principales endpoints y cómo interactuar con ellos.

### Endpoint de API para Power BI

Este endpoint está diseñado para ser consumido por herramientas de Business Intelligence.

- **URL**: `http://localhost:5001/api/data`
- **Método**: `GET`
- **Autenticación**: Básica (Basic Auth).

#### ¿Cómo probarlo?

Puedes usar una herramienta como `curl` desde tu terminal. Reemplaza `tu_usuario` y `tu_password` con las credenciales que definiste en tu archivo `.env`.

```bash
curl -u "tu_usuario:tu_password" http://localhost:5001/api/data
```

**Respuesta Esperada**: Un objeto JSON con dos claves: `tasks_report` y `time_logs_details`.

## Validación de la Estructura de las Tablas

Para asegurar que la aplicación funcione correctamente, es importante que las tablas en cada base de datos tengan la estructura esperada. A continuación se detalla la definición SQL de cada tabla.

### 1. Supabase (PostgreSQL) - Tabla `tasks`

La estructura de esta tabla se define durante el **Paso 2** de la guía de instalación. Puedes verificarla en el **Table Editor** de Supabase.

```sql
CREATE TABLE public.tasks (
  id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  title text NOT NULL,
  done boolean NOT NULL DEFAULT false,
  user_id uuid NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
  category_id integer
);
```

### 2. SQLite - Tabla `categories`

Esta tabla se crea automáticamente en el archivo `local_database.db` al iniciar la aplicación.

```sql
CREATE TABLE categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE
);
```

### 3. MySQL - Tabla `time_logs`

Esta tabla también se crea automáticamente al iniciar la aplicación en la base de datos MySQL.

```sql
CREATE TABLE time_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    task_id INT NOT NULL,
    user_id VARCHAR(255) NOT NULL,
    duration_minutes INT NOT NULL,
    log_date DATE NOT NULL
);
```

### Endpoints de la Aplicación Web

| Ruta                                | Método(s)  | Descripción                                               | Requiere Autenticación |
| ----------------------------------- | ---------- | --------------------------------------------------------- | ---------------------- |
| `/`                                 | `GET`      | Muestra la página principal con la lista de tareas.       | Sí                     |
| `/login`                            | `GET`, `POST` | Muestra y procesa el formulario de inicio de sesión.   | No                     |
| `/register`                         | `GET`, `POST` | Muestra y procesa el formulario de registro.           | No                     |
| `/logout`                           | `GET`      | Cierra la sesión del usuario.                             | Sí                     |
| `/add`                              | `POST`     | Agrega una nueva tarea.                                   | Sí                     |
| `/done/<int:task_id>`               | `GET`      | Marca una tarea como completada.                          | Sí                     |
| `/delete/<int:task_id>`             | `GET`      | Elimina una tarea.                                        | Sí                     |
| `/edit/<int:task_id>`               | `GET`, `POST` | Muestra y procesa el formulario para editar una tarea. | Sí                     |
| `/categories`                       | `GET`      | Muestra la página para gestionar categorías.              | Sí                     |
| `/categories/add`                   | `POST`     | Agrega una nueva categoría.                               | Sí                     |
| `/categories/delete/<int:cat_id>`   | `GET`      | Elimina una categoría.                                    | Sí                     |
| `/dashboard`                        | `GET`      | Muestra el dashboard de productividad.                    | Sí                     |
| `/export`                           | `GET`      | Muestra la página para seleccionar reportes.              | Sí                     |
| `/export/csv`                       | `GET`      | Genera y descarga el reporte CSV solicitado.              | Sí (para reportes personales) |
| `/history/<int:task_id>`            | `GET`      | Muestra el historial de tiempo de una tarea.              | Sí                     |
| `/log_time/<int:task_id>`           | `POST`     | Registra tiempo para una tarea específica.                | Sí                     |

## Estructura del Proyecto

```
/
|-- app.py                # Archivo principal de la aplicación Flask
|-- db_mysql.py           # Lógica de conexión e inicialización para MySQL
|-- db_sqlite.py          # Lógica de conexión e inicialización para SQLite
|-- requirements.txt      # Dependencias de Python
|-- Dockerfile            # Instrucciones para construir la imagen de la app
|-- docker-compose.yml    # Orquestación de los contenedores (app y mysql)
|-- .env.example          # Plantilla para las variables de entorno
|-- README.md             # Esta documentación
|-- templates/            # Carpeta con todas las plantillas HTML
|   |-- base.html
|   |-- tasks.html
|   |-- ...
```

```

### 2. Nuevo Archivo: `.env.example`

Este archivo sirve como una plantilla clara para que los usuarios sepan qué variables de entorno necesitan configurar.

```diff
# Variables de Entorno para la Aplicación
# Copia este archivo a .env y rellena los valores.

# Supabase - Encuentra estos valores en tu proyecto de Supabase > Project Settings > API
SUPABASE_URL="https://tu_id_de_proyecto.supabase.co"
SUPABASE_KEY="clave"
FLASK_SECRET_KEY="clave"

# MySQL/MariaDB - Credenciales para el contenedor de Docker
MYSQL_HOST="db"
MYSQL_USER="root"
MYSQL_PASSWORD="clave"
MYSQL_DB="task_manager_db"

# Basic Auth para el API de Power BI
API_USER="powerbi"
API_PASSWORD="clave"
